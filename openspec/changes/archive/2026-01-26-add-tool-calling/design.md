# Design: ReAct Agent æ¶æ„è®¾è®¡ï¼ˆMCP æ–¹æ¡ˆï¼‰

## Context

æ—…è¡ŒåŠ©æ‰‹éœ€è¦ä»çº¯å¯¹è¯æ¨¡å¼å‡çº§ä¸ºå…·æœ‰å·¥å…·è°ƒç”¨èƒ½åŠ›çš„ ReAct Agentã€‚é‡‡ç”¨ LangChain MCP Adapters é›†æˆç°æœ‰çš„ MCP æœåŠ¡ï¼ŒåŒæ—¶æ”¯æŒæœ¬åœ°å·¥å…·ï¼ˆå¦‚å½“å‰æ—¥æœŸï¼‰ã€‚**ç”¨æˆ·éœ€è¦çœ‹åˆ° Agent çš„æ€è€ƒå’Œå·¥å…·è°ƒç”¨è¿‡ç¨‹**ã€‚

### çº¦æŸæ¡ä»¶

- ä½¿ç”¨ DashScopeï¼ˆé˜¿é‡Œäº‘ï¼‰APIï¼Œéœ€ç¡®è®¤ Function Calling æ”¯æŒ
- ä¿æŒæµå¼è¾“å‡ºä½“éªŒ
- å®æ—¶å±•ç¤ºå·¥å…·è°ƒç”¨æ­¥éª¤
- å‘åå…¼å®¹ç°æœ‰å¯¹è¯åŠŸèƒ½
- Next.js åç«¯éœ€è¦ç®¡ç† MCP å­è¿›ç¨‹

## Goals / Non-Goals

### Goals

- **å®ç° ReAct Agent æ¶æ„**ï¼ˆThought â†’ Action â†’ Observation å¾ªç¯ï¼‰
- **å®æ—¶å±•ç¤ºå·¥å…·è°ƒç”¨æ­¥éª¤**ï¼ˆæ€è€ƒã€è°ƒç”¨ã€ç»“æœï¼‰
- å®ç°å½“å‰æ—¥æœŸæœ¬åœ°å·¥å…·
- é€šè¿‡ MCP é›†æˆï¼šAmapï¼ˆå¤©æ°”/POIï¼‰ã€Variflightï¼ˆèˆªç­ï¼‰ã€12306ï¼ˆç«è½¦ï¼‰
- Agent èƒ½è‡ªåŠ¨åˆ¤æ–­ä½•æ—¶è°ƒç”¨å·¥å…·
- ä¿æŒæµå¼è¾“å‡ºä½“éªŒ
- å·¥å…·è°ƒç”¨å¤±è´¥æ—¶ä¼˜é›…é™çº§

### Non-Goals

- ä¸å®ç°æ±‡ç‡æŸ¥è¯¢ï¼ˆç”¨æˆ·ä¸éœ€è¦ï¼‰
- ä¸å®ç°ç”¨æˆ·è‡ªå®šä¹‰å·¥å…·

## Decisions

### Decision 1: ReAct Agent æ¶æ„

**é€‰æ‹©**: ä½¿ç”¨ LangChain çš„ `createReactAgent` åˆ›å»º ReAct é£æ ¼çš„ Agentã€‚

**ReAct å¾ªç¯**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·: "ä¸œäº¬ä»Šå¤©å¤©æ°”æ€ä¹ˆæ ·ï¼Ÿ"                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¤” Thought: ç”¨æˆ·æƒ³çŸ¥é“ä¸œäº¬çš„å¤©æ°”ï¼Œæˆ‘éœ€è¦å…ˆè·å–å½“å‰æ—¥æœŸ  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”§ Action: get_current_date()                          â”‚
â”‚  ğŸ“‹ Observation: å½“å‰æ—¥æœŸæ˜¯ï¼š2026å¹´1æœˆ26æ—¥ï¼Œæ˜ŸæœŸä¸€       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¤” Thought: ç°åœ¨æˆ‘çŸ¥é“æ˜¯1æœˆ26æ—¥ï¼Œéœ€è¦æŸ¥è¯¢ä¸œäº¬å¤©æ°”       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”§ Action: amap_weather({ city: "ä¸œäº¬" })              â”‚
â”‚  ğŸ“‹ Observation: ä¸œäº¬ä»Šå¤©æ™´ï¼Œæ¸©åº¦8Â°Cï¼Œä½“æ„Ÿæ¸©åº¦5Â°C       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ… Final Answer: ä¸œäº¬ä»Šå¤©ï¼ˆ1æœˆ26æ—¥ï¼‰å¤©æ°”æ™´æœ—...         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Decision 2: ä½¿ç”¨ @langchain/mcp-adapters

**é€‰æ‹©**: ä½¿ç”¨ `@langchain/mcp-adapters` çš„ `MultiServerMCPClient` è¿æ¥å¤šä¸ª MCP æœåŠ¡ã€‚

**åŸå› **:

- å®˜æ–¹æ”¯æŒï¼Œä¸ LangChain ç”Ÿæ€æ— ç¼é›†æˆ
- æ”¯æŒå¤šä¸ª MCP æœåŠ¡å™¨å¹¶å‘
- è‡ªåŠ¨å¤„ç†å·¥å…·å‘ç°å’Œè°ƒç”¨

**æ›¿ä»£æ–¹æ¡ˆ**:

- ç›´æ¥å°è£… APIï¼šéœ€è¦æ‰‹åŠ¨å®ç°æ¯ä¸ª API è°ƒç”¨
- è‡ªå»º MCP å®¢æˆ·ç«¯ï¼šé‡å¤é€ è½®å­

### Decision 2: æ··åˆå·¥å…·æ¶æ„

**é€‰æ‹©**: æœ¬åœ°å·¥å…· + MCP å·¥å…·æ··åˆä½¿ç”¨

```typescript
// æœ¬åœ°å·¥å…·
const localTools = [currentDateTool];

// MCP å·¥å…·
const mcpTools = await mcpClient.getTools();

// åˆå¹¶ä½¿ç”¨
const allTools = [...localTools, ...mcpTools];
```

**åŸå› **:

- ç®€å•å·¥å…·ï¼ˆå¦‚æ—¥æœŸï¼‰æ— éœ€å¤–éƒ¨æœåŠ¡
- å¤æ‚å·¥å…·ï¼ˆå¦‚å¤©æ°”ï¼‰åˆ©ç”¨ç°æœ‰ MCP æœåŠ¡

### Decision 3: MCP æœåŠ¡é€‰æ‹©

| æœåŠ¡     | MCP åŒ…                          | åŠŸèƒ½                           |
| -------- | ------------------------------- | ------------------------------ |
| é«˜å¾·åœ°å›¾ | `@amap/amap-mcp`                | å¤©æ°”æŸ¥è¯¢ã€POI æœç´¢ã€è·¯çº¿è§„åˆ’   |
| é£å¸¸å‡†   | `@variflight-ai/variflight-mcp` | èˆªç­æŸ¥è¯¢ã€æœºåœºå¤©æ°”ã€èˆªç­èˆ’é€‚åº¦ |
| 12306    | ModelScope éƒ¨ç½²                 | ç«è½¦ç¥¨æŸ¥è¯¢ã€è½¦æ¬¡ä¿¡æ¯           |

### Decision 4: MCP è¿›ç¨‹ç”Ÿå‘½å‘¨æœŸ

**é€‰æ‹©**: å•ä¾‹æ¨¡å¼ï¼Œåº”ç”¨å¯åŠ¨æ—¶åˆå§‹åŒ– MCP è¿æ¥

```typescript
// mcp-client.ts
let mcpClient: MultiServerMCPClient | null = null;

export async function getMCPClient() {
  if (!mcpClient) {
    mcpClient = new MultiServerMCPClient({ ... });
    await mcpClient.initializeConnections();
  }
  return mcpClient;
}
```

**åŸå› **:

- é¿å…æ¯æ¬¡è¯·æ±‚éƒ½å¯åŠ¨ MCP è¿›ç¨‹
- å‡å°‘å»¶è¿Ÿï¼Œæé«˜å“åº”é€Ÿåº¦

### Decision 5: Agent äº‹ä»¶æµæ ¼å¼

**é€‰æ‹©**: é€šè¿‡ SSE å®æ—¶æ¨é€ Agent çš„å„ä¸ªæ­¥éª¤

```typescript
// SSE äº‹ä»¶ç±»å‹
type AgentEvent =
  | { type: 'thinking'; content: string } // æ€è€ƒè¿‡ç¨‹
  | { type: 'tool_start'; name: string; input: Record<string, unknown> } // å¼€å§‹è°ƒç”¨å·¥å…·
  | { type: 'tool_end'; name: string; output: string } // å·¥å…·è¿”å›ç»“æœ
  | { type: 'content'; content: string } // æœ€ç»ˆå›ç­”å†…å®¹
  | { type: 'error'; message: string } // é”™è¯¯
  | { done: true }; // å®Œæˆ
```

**ç¤ºä¾‹ SSE æµ**:

```
data: {"type":"thinking","content":"ç”¨æˆ·æƒ³çŸ¥é“ä¸œäº¬å¤©æ°”ï¼Œæˆ‘éœ€è¦å…ˆè·å–æ—¥æœŸ"}
data: {"type":"tool_start","name":"get_current_date","input":{}}
data: {"type":"tool_end","name":"get_current_date","output":"2026å¹´1æœˆ26æ—¥ï¼Œæ˜ŸæœŸä¸€"}
data: {"type":"thinking","content":"ç°åœ¨æŸ¥è¯¢ä¸œäº¬å¤©æ°”"}
data: {"type":"tool_start","name":"amap_weather","input":{"city":"ä¸œäº¬"}}
data: {"type":"tool_end","name":"amap_weather","output":"æ™´ï¼Œ8Â°C"}
data: {"type":"content","content":"ä¸œäº¬ä»Šå¤©ï¼ˆ1æœˆ26æ—¥ï¼‰"}
data: {"type":"content","content":"å¤©æ°”æ™´æœ—ï¼Œæ¸©åº¦8Â°C..."}
data: {"done":true}
```

### Decision 6: å‰ç«¯å·¥å…·è°ƒç”¨å±•ç¤º

**é€‰æ‹©**: åœ¨æ¶ˆæ¯ä¸­åµŒå…¥å¯æŠ˜å çš„å·¥å…·è°ƒç”¨æ­¥éª¤ç»„ä»¶

```tsx
// ToolCallStatus ç»„ä»¶
<MessageItem>
  {/* å·¥å…·è°ƒç”¨æ­¥éª¤ï¼ˆå¯æŠ˜å ï¼‰ */}
  <ToolCallSteps
    steps={[
      { type: 'thinking', content: 'æ­£åœ¨åˆ†æé—®é¢˜...' },
      {
        type: 'tool',
        name: 'è·å–æ—¥æœŸ',
        status: 'success',
        result: '2026å¹´1æœˆ26æ—¥',
      },
      { type: 'tool', name: 'æŸ¥è¯¢å¤©æ°”', status: 'loading' },
    ]}
  />

  {/* æœ€ç»ˆå›ç­” */}
  <MarkdownRenderer content={message.content} />
</MessageItem>
```

**UI è®¾è®¡**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¤– å®‰å®‰ä¼´æ—…                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â–¼ å·¥å…·è°ƒç”¨ (2ä¸ªæ­¥éª¤)                            â”‚
â”‚   â”œâ”€ âœ… è·å–å½“å‰æ—¥æœŸ â†’ 2026å¹´1æœˆ26æ—¥            â”‚
â”‚   â””â”€ âœ… æŸ¥è¯¢ä¸œäº¬å¤©æ°” â†’ æ™´ï¼Œ8Â°C                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ä¸œäº¬ä»Šå¤©ï¼ˆ1æœˆ26æ—¥æ˜ŸæœŸä¸€ï¼‰å¤©æ°”æ™´æœ—ï¼Œæ¸©åº¦8Â°C...   â”‚
â”‚                                                â”‚
â”‚ å»ºè®®ï¼š                                         â”‚
â”‚ 1. ç©¿ç€ä¿æš–å¤–å¥—                                â”‚
â”‚ 2. ...                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç”¨æˆ·è¾“å…¥                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     AgentExecutor                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                   Tool Calling Agent                 â”‚    â”‚
â”‚  â”‚                                                      â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚  â”‚  â”‚   Local Tools    â”‚  â”‚      MCP Tools           â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  â”‚CurrentDate â”‚  â”‚  â”‚  â”‚ Amap   â”‚ â”‚Variflightâ”‚ â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚  â”‚Weather â”‚ â”‚ Flight  â”‚  â”‚ â”‚    â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚  â”‚POI     â”‚ â”‚         â”‚  â”‚ â”‚    â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚    â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚ â”‚    â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚  â”‚ 12306   â”‚             â”‚ â”‚    â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚  â”‚ Train   â”‚             â”‚ â”‚    â”‚
â”‚  â”‚  â”‚                  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚ â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MultiServerMCPClient                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  amap-mcp   â”‚  â”‚ variflight  â”‚  â”‚     12306-mcp       â”‚  â”‚
â”‚  â”‚   (stdio)   â”‚  â”‚    (stdio)  â”‚  â”‚  (HTTP/ModelScope)  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## File Structure

```
src/
â”œâ”€â”€ lib/langchain/
â”‚   â”œâ”€â”€ tools/
â”‚   â”‚   â”œâ”€â”€ index.ts           # å·¥å…·å¯¼å‡º
â”‚   â”‚   â””â”€â”€ current-date.ts    # å½“å‰æ—¥æœŸå·¥å…·ï¼ˆæœ¬åœ°ï¼‰
â”‚   â”œâ”€â”€ mcp-client.ts          # MCP å®¢æˆ·ç«¯é…ç½®
â”‚   â”œâ”€â”€ agent.ts               # ReAct Agent é…ç½®å’Œæ‰§è¡Œ
â”‚   â”œâ”€â”€ chain.ts               # ä¿ç•™ï¼Œå‘åå…¼å®¹
â”‚   â”œâ”€â”€ model.ts               # æ¨¡å‹é…ç½®ï¼ˆä¸å˜ï¼‰
â”‚   â””â”€â”€ prompts.ts             # æ›´æ–° System Prompt
â”œâ”€â”€ components/chat/
â”‚   â”œâ”€â”€ ToolCallSteps.tsx      # å·¥å…·è°ƒç”¨æ­¥éª¤å±•ç¤ºç»„ä»¶ï¼ˆæ–°å¢ï¼‰
â”‚   â””â”€â”€ MessageItem.tsx        # æ›´æ–°æ”¯æŒå·¥å…·æ­¥éª¤
â”œâ”€â”€ types/
â”‚   â””â”€â”€ chat.ts                # æ·»åŠ  AgentEvent ç±»å‹
â””â”€â”€ store/
    â””â”€â”€ chat-store.ts          # æ·»åŠ å·¥å…·è°ƒç”¨çŠ¶æ€
```

## Tool Definitions

### æœ¬åœ°å·¥å…·ï¼šå½“å‰æ—¥æœŸ

```typescript
// tools/current-date.ts
import { tool } from '@langchain/core/tools';
import { z } from 'zod';

export const currentDateTool = tool(
  async () => {
    const now = new Date();
    const options: Intl.DateTimeFormatOptions = {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      weekday: 'long',
      timeZone: 'Asia/Shanghai',
    };
    return `å½“å‰æ—¥æœŸæ˜¯ï¼š${now.toLocaleDateString('zh-CN', options)}`;
  },
  {
    name: 'get_current_date',
    description: 'è·å–å½“å‰æ—¥æœŸå’Œæ˜ŸæœŸå‡ ï¼Œç”¨äºå›ç­”ä¸æ—¶é—´ç›¸å…³çš„é—®é¢˜',
    schema: z.object({}),
  }
);
```

### MCP å®¢æˆ·ç«¯é…ç½®

```typescript
// mcp-client.ts
import { MultiServerMCPClient } from '@langchain/mcp-adapters';

export function createMCPClient() {
  return new MultiServerMCPClient({
    throwOnLoadError: false,
    prefixToolNameWithServerName: true,
    mcpServers: {
      amap: {
        transport: 'stdio',
        command: 'npx',
        args: ['-y', '@amap/amap-mcp'],
        env: { AMAP_API_KEY: process.env.AMAP_API_KEY },
      },
      variflight: {
        transport: 'stdio',
        command: 'npx',
        args: ['-y', '@variflight-ai/variflight-mcp'],
        env: { VARIFLIGHT_API_KEY: process.env.VARIFLIGHT_API_KEY },
      },
      train: {
        transport: 'sse',
        url: process.env.MCP_12306_URL,
      },
    },
  });
}
```

## Risks / Trade-offs

| é£é™©                        | å½±å“           | ç¼“è§£æªæ–½         |
| --------------------------- | -------------- | ---------------- |
| MCP è¿›ç¨‹å¯åŠ¨æ…¢              | é¦–æ¬¡è¯·æ±‚å»¶è¿Ÿé«˜ | åº”ç”¨å¯åŠ¨æ—¶é¢„çƒ­   |
| MCP æœåŠ¡ä¸ç¨³å®š              | å·¥å…·è°ƒç”¨å¤±è´¥   | é™çº§ä¸ºçº¯å¯¹è¯æ¨¡å¼ |
| æ¨¡å‹ä¸æ”¯æŒ Function Calling | åŠŸèƒ½ä¸å¯ç”¨     | æµ‹è¯•ç¡®è®¤åå†å®ç° |
| å­è¿›ç¨‹å†…å­˜å ç”¨              | æœåŠ¡å™¨è´Ÿè½½å¢åŠ  | ç›‘æ§å¹¶æŒ‰éœ€ä¼˜åŒ–   |

## Environment Variables

åœ¨ `.env.local` ä¸­é…ç½®ï¼ˆå·²æœ‰çš„ Keyï¼‰ï¼š

```bash
# é«˜å¾·åœ°å›¾ WebæœåŠ¡ API Key
AMAP_API_KEY=xxx

# é£å¸¸å‡† API Key
VARIFLIGHT_API_KEY=xxx

# 12306 MCP (ModelScope éƒ¨ç½²)
MCP_12306_URL=https://xxx
```

**æ³¨æ„**ï¼šé£å¸¸å‡†çš„ header åç§°æ˜¯ `X-Variflight-Key`ï¼Œéœ€è¦åœ¨ MCP é…ç½®ä¸­ä½¿ç”¨ã€‚

## Open Questions

1. DashScope çš„ qwen-plus æ¨¡å‹æ˜¯å¦å®Œæ•´æ”¯æŒ Function Callingï¼Ÿ
2. Next.js Edge Runtime æ˜¯å¦æ”¯æŒ stdio å­è¿›ç¨‹ï¼Ÿï¼ˆå¯èƒ½éœ€è¦ Node.js Runtimeï¼‰
3. 12306 MCP çš„ ModelScope éƒ¨ç½² URL æ ¼å¼æ˜¯ä»€ä¹ˆï¼Ÿ
